package com.kmh.kamco.controller;

import com.kmh.kamco.dto.KamcoApiResponse;
import com.kmh.kamco.dto.Item; // Item DTO 임포트
import com.kmh.kamco.service.KamcoApiService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.ArrayList;
import java.util.LinkedHashMap; // Map에 추가된 순서를 유지하기 위해 사용
import java.util.List;
import java.util.Map;

@Controller
public class KamcoController {

 private final KamcoApiService kamcoApiService;

 public KamcoController(KamcoApiService kamcoApiService) {
     this.kamcoApiService = kamcoApiService;
 }

 @GetMapping("/")
 public String index(Model model) {
     return "redirect:/auction";
 }

 @GetMapping("/auction")
 public String getAuctionList(
         @RequestParam(value = "pageNo", defaultValue = "1") int pageNo,
         Model model) {

     KamcoApiResponse response = kamcoApiService.getAuctionItems(String.valueOf(pageNo));
     List<Item> uniqueItems = new ArrayList<>(); // RNUM 기준으로 중복이 제거된 아이템 리스트

     if (response != null && response.getHeader() != null) {
         if ("00".equals(response.getHeader().getResultCode())) {
             if (response.getBody() != null && response.getBody().getItemList() != null && !response.getBody().getItemList().isEmpty()) {
                 // RNUM을 키로 사용하여 중복을 제거할 Map 생성
                 // LinkedHashMap은 삽입 순서를 유지하므로, 첫 번째 발견된 RNUM 항목이 유지됩니다.
                 Map<String, Item> itemMapByRNUM = new LinkedHashMap<>();

                 for (Item item : response.getBody().getItemList()) {
                     // RNUM이 null이 아니거나 비어있지 않은 경우에만 처리
                     if (item.getRNUM() != null && !item.getRNUM().isEmpty()) {
                         // Map에 해당 RNUM이 이미 없으면 추가 (중복 제거)
                         itemMapByRNUM.putIfAbsent(item.getRNUM(), item);
                     }
                 }
                 uniqueItems = new ArrayList<>(itemMapByRNUM.values()); // Map의 값들을 리스트로 변환

                 model.addAttribute("items", uniqueItems); // 중복 제거된 리스트를 모델에 추가
             } else {
                 model.addAttribute("message", "조회된 공매 물건이 없습니다.");
             }
         } else if ("99".equals(response.getHeader().getResultCode())) {
             model.addAttribute("message", response.getHeader().getResultMsg());
         } else {
             model.addAttribute("message", "API 호출 실패: " + response.getHeader().getResultMsg());
         }
     } else {
         model.addAttribute("message", "API 호출 실패: 응답을 받지 못했습니다. (네트워크 문제 또는 예상치 못한 서비스 오류)");
     }

     model.addAttribute("currentPage", pageNo);
     return "auctionList";
 }
}