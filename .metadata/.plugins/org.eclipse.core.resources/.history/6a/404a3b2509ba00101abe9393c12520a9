package com.kmh.kamco.dto;

import com.example.kamco.dto.KamcoApiResponse;
import com.fasterxml.jackson.dataformat.xml.XmlMapper;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.HttpServerErrorException;
import org.springframework.web.client.ResourceAccessException;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

@Service
public class KamcoApiService {

    @Value("${kamco.api.url}")
    private String apiUrl;

    @Value("${kamco.api.service-key}")
    private String serviceKey;

    private final RestTemplate restTemplate;
    private final XmlMapper xmlMapper;

    public KamcoApiService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
        this.xmlMapper = new XmlMapper();
    }

    // numOfRows 파라미터를 제거하고, 항상 100을 사용하도록 수정합니다.
    public KamcoApiResponse getAuctionItems(String pageNo) {
        UriComponentsBuilder uriBuilder = UriComponentsBuilder.fromHttpUrl(apiUrl)
                .queryParam("serviceKey", serviceKey)
                .queryParam("pageNo", pageNo)         // 페이지 번호
                .queryParam("numOfRows", "100");      // <-- 항상 100건 요청하도록 고정

        String url = uriBuilder.build().toUriString();
        System.out.println(">>> KAMCO API 호출 URL: " + url);

        try {
            String xmlResponse = restTemplate.getForObject(url, String.class);
            
            if (xmlResponse == null || xmlResponse.isEmpty()) {
                System.err.println("KAMCO API로부터 빈 응답을 받았습니다.");
                return null;
            }
            
            System.out.println(">>> KAMCO API XML 응답: \n" + xmlResponse);
            
            return xmlMapper.readValue(xmlResponse, KamcoApiResponse.class);
            
        } catch (HttpClientErrorException e) {
            System.err.println("클라이언트 오류 발생 (4xx): " + e.getStatusCode() + " - " + e.getResponseBodyAsString());
            return null;
        } catch (HttpServerErrorException e) {
            System.err.println("서버 오류 발생 (5xx): " + e.getStatusCode() + " - " + e.getResponseBodyAsString());
            return null;
        } catch (ResourceAccessException e) {
            System.err.println("네트워크 연결 오류: " + e.getMessage());
            e.printStackTrace();
            return null;
        } catch (Exception e) {
            System.err.println("KAMCO API 호출 중 알 수 없는 오류 발생: " + e.getMessage());
            e.printStackTrace();
            return null;
        }
    }
}
2. KamcoController.java 수정
getAuctionList 메서드에서 numOfRows 관련 @RequestParam과 kamcoApiService.getAuctionItems() 호출 시 numOfRows 파라미터를 제거합니다.

java


// src/main/java/com/example/kamco/controller/KamcoController.java
package com.example.kamco.controller;

import com.example.kamco.dto.KamcoApiResponse;
import com.example.kamco.service.KamcoApiService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

@Controller
public class KamcoController {

    private final KamcoApiService kamcoApiService;

    public KamcoController(KamcoApiService kamcoApiService) {
        this.kamcoApiService = kamcoApiService;
    }

    @GetMapping("/")
    public String index(Model model) {
        return "redirect:/auction";
    }

    @GetMapping("/auction")
    public String getAuctionList(
            @RequestParam(value = "pageNo", defaultValue = "1") String pageNo,
            // numOfRows는 서비스 내부에서 고정하므로 여기서는 제거합니다.
            Model model) {

        // 서비스 메서드 호출 시 pageNo만 전달합니다.
        KamcoApiResponse response = kamcoApiService.getAuctionItems(pageNo);

        if (response != null && response.getHeader() != null && "00".equals(response.getHeader().getResultCode())) {
            if (response.getBody() != null && response.getBody().getItemList() != null) {
                model.addAttribute("items", response.getBody().getItemList());
            } else {
                model.addAttribute("message", "조회된 공매 물건이 없습니다.");
            }
        } else {
            String errorMessage = "API 호출 실패: ";
            if (response != null && response.getHeader() != null) {
                errorMessage += response.getHeader().getResultMsg();
            } else {
                errorMessage += "응답을 받지 못했습니다. (네트워크 문제 또는 서버 응답 없음)";
            }
            model.addAttribute("message", errorMessage);
        }

        model.addAttribute("currentPage", pageNo);
        // model.addAttribute("numOfRows", "100"); // 필요하다면 화면에 100건 조회되었다는 정보를 넘길 수 있습니다.
        return "auctionList";
    }
}