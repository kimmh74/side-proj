package com.kmh.kamco.controller;

import com.example.kamco.dto.KamcoApiResponse;
import com.example.kamco.service.KamcoApiService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

@Controller
public class KamcoController {

    private final KamcoApiService kamcoApiService;

    public KamcoController(KamcoApiService kamcoApiService) {
        this.kamcoApiService = kamcoApiService;
    }

    @GetMapping("/")
    public String index(Model model) {
        return "redirect:/auction";
    }

    @GetMapping("/auction")
    public String getAuctionList(
            @RequestParam(value = "pageNo", defaultValue = "1") int pageNo, // <-- pageNo를 int 타입으로 변경
            Model model) {

        // pageNo가 int로 들어오므로, 서비스 계층으로 String으로 다시 전달해야 한다면 String.valueOf(pageNo) 사용
        KamcoApiResponse response = kamcoApiService.getAuctionItems(String.valueOf(pageNo));

        if (response != null && response.getHeader() != null) {
            if ("00".equals(response.getHeader().getResultCode())) {
                if (response.getBody() != null && response.getBody().getItemList() != null) {
                    model.addAttribute("items", response.getBody().getItemList());
                } else {
                    model.addAttribute("message", "조회된 공매 물건이 없습니다.");
                }
            } else if ("99".equals(response.getHeader().getResultCode())) {
                model.addAttribute("message", response.getHeader().getResultMsg());
            }
            else {
                model.addAttribute("message", "API 호출 실패: " + response.getHeader().getResultMsg());
            }
        } else {
            model.addAttribute("message", "API 호출 실패: 응답을 받지 못했습니다. (네트워크 문제 또는 예상치 못한 서비스 오류)");
        }

        model.addAttribute("currentPage", pageNo); // <-- int 타입의 pageNo를 모델에 추가
        return "auctionList";
    }
}