// src/main/java/com/example/kamco/controller/KamcoController.java
package com.kmh.kamco.controller;

import com.kmh.kamco.dto.KamcoApiResponse;
import com.kmh.kamco.dto.Item;
import com.kmh.kamco.service.KamcoApiService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors; // Collectors 추가

@Controller
public class KamcoController {

    private final KamcoApiService kamcoApiService;

    // UI에서 한 번에 보여줄 아이템 수 (HTML 페이지 당)
    private static final int UI_PAGE_SIZE = 50;
    // KAMCO API 한 번 호출로 받아올 아이템 수
    private static final int API_NUM_OF_ROWS = 100;
    // UI 페이지 하나를 커버하기 위해 필요한 API 호출 횟수 (100 / 50 = 2)
    private static final int API_CALLS_PER_UI_PAGE_GROUP = API_NUM_OF_ROWS / UI_PAGE_SIZE;


    public KamcoController(KamcoApiService kamcoApiService) {
        this.kamcoApiService = kamcoApiService;
    }

    @GetMapping("/")
    public String index(Model model) {
        return "redirect:/auction";
    }

    @GetMapping("/auction")
    public String getAuctionList(
            @RequestParam(value = "pageNo", defaultValue = "1") int uiPageNo, // UI 상의 현재 페이지 번호
            Model model) {

        List<Item> displayedItems = new ArrayList<>(); // 화면에 최종적으로 보여줄 아이템 리스트
        int totalFilteredItemsCount = 0; // 필터링(중복 제거)된 총 아이템 수 (예측치)

        // API 호출을 위한 페이지 번호 계산
        // uiPageNo 1,2 -> apiPageNo 1
        // uiPageNo 3,4 -> apiPageNo 2
        // ...
        int apiPageNo = ((uiPageNo - 1) / API_CALLS_PER_UI_PAGE_GROUP) + 1;
        
        // API 응답에서 데이터를 가져올 때 시작 인덱스와 끝 인덱스 계산
        int startIndexInApiResult = ((uiPageNo - 1) % API_CALLS_PER_UI_PAGE_GROUP) * UI_PAGE_SIZE;
        int endIndexInApiResult = startIndexInApiResult + UI_PAGE_SIZE;


        KamcoApiResponse response = kamcoApiService.getAuctionItems(String.valueOf(apiPageNo), String.valueOf(API_NUM_OF_ROWS));

        if (response != null && response.getHeader() != null) {
            if ("00".equals(response.getHeader().getResultCode())) {
                if (response.getBody() != null && response.getBody().getItemList() != null && !response.getBody().getItemList().isEmpty()) {
                    // RNUM을 키로 사용하여 중복을 제거할 Map 생성 (API 응답 전체에 대해)
                    Map<String, Item> itemMapByRNUM = new LinkedHashMap<>();
                    for (Item item : response.getBody().getItemList()) {
                        if (item.getRNUM() != null && !item.getRNUM().isEmpty()) {
                            itemMapByRNUM.putIfAbsent(item.getRNUM(), item); // 첫 번째 발견된 RNUM만 유지
                        }
                    }
                    List<Item> allFilteredItems = new ArrayList<>(itemMapByRNUM.values());
                    totalFilteredItemsCount = allFilteredItems.size(); // 필터링된 아이템 총 수

                    // UI_PAGE_SIZE 만큼만 잘라서 화면에 보여줄 리스트 생성
                    if (startIndexInApiResult < totalFilteredItemsCount) {
                        endIndexInApiResult = Math.min(endIndexInApiResult, totalFilteredItemsCount);
                        displayedItems = allFilteredItems.subList(startIndexInApiResult, endIndexInApiResult);
                    } else {
                        // 요청한 페이지에 해당하는 데이터가 없을 경우 (예: 마지막 페이지에서 다음 버튼 누름)
                        displayedItems = new ArrayList<>();
                    }

                    model.addAttribute("items", displayedItems);
                } else {
                    model.addAttribute("message", "조회된 공매 물건이 없습니다.");
                }
            } else if ("99".equals(response.getHeader().getResultCode())) {
                model.addAttribute("message", response.getHeader().getResultMsg());
            } else {
                model.addAttribute("message", "API 호출 실패: " + response.getHeader().getResultMsg());
            }
        } else {
            model.addAttribute("message", "API 호출 실패: 응답을 받지 못했습니다. (네트워크 문제 또는 예상치 못한 서비스 오류)");
        }

        model.addAttribute("currentPage", uiPageNo);
        // "다음" 버튼 활성화를 위한 마지막 페이지 여부 판단 (임시)
        // 실제 API가 총 건수를 제공하지 않으면 정확한 마지막 페이지는 알 수 없으므로,
        // 현재 페이지의 마지막 아이템이 UI_PAGE_SIZE 보다 적으면 다음 페이지가 없다고 가정합니다.
        boolean hasNextPage = displayedItems.size() == UI_PAGE_SIZE;
        model.addAttribute("hasNextPage", hasNextPage);

        return "auctionList";
    }
}